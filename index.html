<!DOCTYPE html>
<html lang="sk">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>PodClone</title>
<style>
:root {
  --bg: #ffffff;
  --card: #ffffff;
  --surface: #f6f7f8;
  --accent: #1a73e8;
  --text: #202124;
  --text-secondary: #5f6368;
  --radius: 6px;
  --shadow: 0 1px 3px rgba(60,64,67,0.15);
}
* { box-sizing: border-box; font-family: 'Roboto', Arial, sans-serif; }
body { margin: 0; background: var(--surface); color: var(--text); display: flex; flex-direction: column; height: 100vh; }
header { display: flex; align-items: center; justify-content: space-between; padding: 0.75rem 1rem; background: var(--card); border-bottom: 1px solid #e8eaed; position: sticky; top: 0; z-index: 10; }
header h1 { font-weight: 500; font-size: 1.1rem; margin: 0; color: var(--text); }
nav { display: flex; gap: 0.75rem; }
nav button { background: none; border: none; color: var(--accent); font-weight: 500; cursor: pointer; padding: 0.35rem 0.6rem; border-radius: 4px; }
nav button.active { background: rgba(26,115,232,0.08); }
.content { flex: 1; overflow-y: auto; padding: 1rem; max-width: 980px; margin: 0 auto; }
.search-row { display:flex; gap:0.5rem; margin-bottom: 1rem; }
.search-row input { flex:1; padding: 0.75rem 1rem; border-radius: 24px; border: 1px solid #dadce0; background: #fff; }
.search-row button { padding: 0.6rem 1rem; background: var(--accent); color: #fff; border: none; border-radius: 24px; cursor: pointer; }
.list { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 1rem; }
.card { background: var(--card); border-radius: var(--radius); padding: 12px; box-shadow: var(--shadow); display: flex; gap: 12px; align-items: center; cursor: pointer; transition: transform 0.12s ease, box-shadow 0.12s ease; border: 1px solid transparent; }
.card:hover { transform: translateY(-4px); box-shadow: 0 4px 12px rgba(60,64,67,0.12); }
.card img { width: 72px; height: 72px; border-radius: 8px; object-fit: cover; flex-shrink: 0; }
.card .meta { display:flex; flex-direction:column; gap:6px; }
.card .title { font-size: 0.98rem; font-weight: 600; color: var(--text); }
.card .subtitle { font-size: 0.85rem; color: var(--text-secondary); }
.card .actions { margin-left:auto; display:flex; gap:8px; align-items:center; }
.small-btn { background: none; border: 1px solid #e0e0e0; padding: 6px 8px; border-radius: 8px; cursor:pointer; font-size:0.9rem; }
.add-btn { background: var(--accent); color: #fff; border: none; padding: 8px 10px; border-radius: 8px; cursor:pointer; }
.detail { max-width: 800px; margin: 1rem auto; background: var(--card); border-radius: 8px; padding: 12px; box-shadow: var(--shadow); }
.episode-row { display:flex; justify-content:space-between; align-items:center; padding:8px 0; border-bottom:1px solid #f1f3f4; }
.episode-row:last-child{border-bottom:none}
.episode-title { font-size:0.95rem; color:var(--text); }
.episode-meta { font-size:0.82rem; color:var(--text-secondary); }
.footer-player { position: sticky; bottom:0; background: var(--card); border-top:1px solid #e8eaed; padding: 8px 12px; display:flex; align-items:center; gap:12px; }
.player-info img { width:56px; height:56px; border-radius:8px; object-fit:cover; }
.player-title { font-weight:600; }
.progress { height:6px; background:#e9ecef; border-radius:6px; width:240px; cursor:pointer; }
.progress > .bar { height:100%; background:var(--accent); width:0%; border-radius:6px; }
.time { font-size:0.82rem; color:var(--text-secondary); margin-left:8px; }
.error-card { padding: 12px; border-radius:8px; background: #fff3cd; color: #665c00; }
@media (max-width:600px){ .list{grid-template-columns: 1fr;} .card img{width:56px;height:56px} .progress{width:120px} }
</style>
</head>
<body>
  <header>
    <h1>PodClone</h1>
    <nav>
      <button id="exploreTab" class="active">Preskúmať</button>
      <button id="libraryTab">Knižnica</button>
    </nav>
  </header>
  <main class="content">
    <section id="exploreSection">
      <div class="search-row">
        <input type="text" id="searchQuery" placeholder="Hľadaj podcast podľa názvu...">
        <button id="searchBtn">Hľadať</button>
      </div>
      <div id="results" class="list"></div>
    </section>

    <section id="librarySection" style="display:none;">
      <div id="libraryList" class="list"></div>
    </section>

    <div id="detailView" style="display:none;"></div>

  </main>

  <div id="playerBar" class="footer-player" style="display:none;">
    <div class="player-info">
      <img id="playerImg" src="" alt="cover">
    </div>
    <div>
      <div class="player-title" id="playerTitle"></div>
      <div id="playerEpisode" style="font-size:0.85rem;color:var(--text-secondary)"></div>
      <div style="display:flex;align-items:center;margin-top:6px;">
        <div class="progress" id="progressBar"><div class="bar" id="progressFill"></div></div>
        <div class="time" id="timeLabel">00:00 / 00:00</div>
      </div>
    </div>
    <div style="margin-left:auto;">
      <button id="playPause" class="small-btn">⏸️</button>
    </div>
  </div>

  <audio id="audio" preload="none"></audio>

  <script>
    const API_KEY = '6e09668dd40a4d2583288af26b371fee';

    // UI references
    const searchQuery = document.getElementById('searchQuery');
    const searchBtn = document.getElementById('searchBtn');
    const results = document.getElementById('results');
    const libraryList = document.getElementById('libraryList');
    const exploreTab = document.getElementById('exploreTab');
    const libraryTab = document.getElementById('libraryTab');
    const exploreSection = document.getElementById('exploreSection');
    const librarySection = document.getElementById('librarySection');
    const detailView = document.getElementById('detailView');
    const playerBar = document.getElementById('playerBar');
    const playerImg = document.getElementById('playerImg');
    const playerTitle = document.getElementById('playerTitle');
    const playerEpisode = document.getElementById('playerEpisode');
    const playPauseBtn = document.getElementById('playPause');
    const audio = document.getElementById('audio');
    const progressBar = document.getElementById('progressBar');
    const progressFill = document.getElementById('progressFill');
    const timeLabel = document.getElementById('timeLabel');

    exploreTab.addEventListener('click', () => { exploreTab.classList.add('active'); libraryTab.classList.remove('active'); exploreSection.style.display = ''; librarySection.style.display = 'none'; detailView.style.display='none'; });
    libraryTab.addEventListener('click', () => { libraryTab.classList.add('active'); exploreTab.classList.remove('active'); exploreSection.style.display = 'none'; librarySection.style.display = ''; detailView.style.display='none'; renderLibrary(); });

    async function searchPodcasts(query){
      const url = `https://listen-api.listennotes.com/api/v2/search?q=${encodeURIComponent(query)}&type=podcast`;
      const res = await fetch(url, { headers: { 'X-ListenAPI-Key': API_KEY } });
      if(!res.ok) throw new Error('Chyba pri volaní API: ' + res.status);
      const data = await res.json();
      return data.results || [];
    }

    function saveSubscriptions(subs){ localStorage.setItem('podclone_subscriptions', JSON.stringify(subs)); }
    function loadSubscriptions(){ return JSON.parse(localStorage.getItem('podclone_subscriptions'))||[]; }

    function normalizeFeed(p){
      const feed = p.rss || p.feedUrl || p.feed_url || p.xmlUrl || p.rssUrl || null;
      return feed && feed.trim().length>0 ? feed : null;
    }

    function getUniqueKey(p){
      // prefer API id, then feed url, then title
      return p.id || normalizeFeed(p) || (p.title || p.title_original || p.name || '').trim() || null;
    }

    function addToLibraryRaw(p){
      const subs = loadSubscriptions();
      const key = getUniqueKey(p);
      if(!key){ alert('Nepodarilo sa identifikovať podcast pre uloženie.'); return; }
      // check duplicates by id or by feedUrl (only when both are present)
      const exists = subs.some(s=> (s.id && p.id && s.id===p.id) || (s.feedUrl && normalizeFeed(p) && s.feedUrl===normalizeFeed(p)) );
      if(exists){ alert('Tento podcast už máš v knižnici.'); return; }
      const toSave = { id: p.id || null, title: p.title || p.title_original || p.name || '', feedUrl: normalizeFeed(p), imgUrl: p.image || p.imgUrl || p.thumbnail || '' , publisher: p.publisher || p.publisher_original || '' };
      subs.push(toSave);
      saveSubscriptions(subs);
      renderLibrary();
      alert(`Podcast „${toSave.title}" pridaný do knižnice.`);
    }

    function removeFromLibrary(idOrFeed){ let subs = loadSubscriptions(); subs = subs.filter(s=> !(s.id===idOrFeed || s.feedUrl===idOrFeed)); saveSubscriptions(subs); renderLibrary(); }

    function renderCard(p){
      const el = document.createElement('div'); el.className='card';
      const img = document.createElement('img'); img.src = p.image || p.imgUrl || p.thumbnail || '';
      const meta = document.createElement('div'); meta.className='meta';
      const title = document.createElement('div'); title.className='title'; title.textContent = p.title || p.title_original || p.name || 'Bez názvu';
      const subtitle = document.createElement('div'); subtitle.className='subtitle'; subtitle.textContent = p.publisher || p.publisher_original || p.description || '';
      meta.appendChild(title); meta.appendChild(subtitle);

      const actions = document.createElement('div'); actions.className='actions';
      const openBtn = document.createElement('button'); openBtn.className='small-btn'; openBtn.textContent='Detail';
      openBtn.addEventListener('click', (e)=>{ e.stopPropagation(); openPodcastDetail(p); });

      const addBtn = document.createElement('button'); addBtn.className='add-btn'; addBtn.textContent='Odoberať';
      addBtn.addEventListener('click',(e)=>{ e.stopPropagation(); addToLibraryRaw(p); });

      actions.appendChild(openBtn); actions.appendChild(addBtn);

      el.appendChild(img); el.appendChild(meta); el.appendChild(actions);
      el.addEventListener('click', ()=> openPodcastDetail(p));
      return el;
    }

    function displayPodcasts(podcasts){ results.innerHTML='';
      if(!Array.isArray(podcasts)||podcasts.length===0){ results.innerHTML='<div class="error-card">Žiadne výsledky.</div>'; return; }
      podcasts.forEach(p=>{ results.appendChild(renderCard(p)); });
    }

    searchBtn.addEventListener('click', async ()=>{ const q = searchQuery.value.trim(); if(!q) return; try{ const pods = await searchPodcasts(q); displayPodcasts(pods); }catch(err){ results.innerHTML=`<div class="error-card">Chyba: ${err.message}</div>` } });

    function renderLibrary(){ libraryList.innerHTML=''; const subs = loadSubscriptions(); if(subs.length===0){ libraryList.innerHTML='<div class="error-card">Žiadne odbery zatiaľ.</div>'; return; }
      subs.forEach(p=>{
        const card = document.createElement('div'); card.className='card';
        const img = document.createElement('img'); img.src=p.imgUrl||'';
        const meta = document.createElement('div'); meta.className='meta';
        const title = document.createElement('div'); title.className='title'; title.textContent=p.title||'Bez názvu';
        const subtitle = document.createElement('div'); subtitle.className='subtitle'; subtitle.textContent=p.publisher||'';
        meta.appendChild(title); meta.appendChild(subtitle);
        const actions = document.createElement('div'); actions.className='actions';
        const openBtn = document.createElement('button'); openBtn.className='small-btn'; openBtn.textContent='Otvoriť'; openBtn.addEventListener('click',(e)=>{ e.stopPropagation(); openPodcastDetail(p); });
        const remBtn = document.createElement('button'); remBtn.className='small-btn'; remBtn.textContent='Odobrať'; remBtn.addEventListener('click',(e)=>{ e.stopPropagation(); removeFromLibrary(p.id||p.feedUrl); });
        actions.appendChild(openBtn); actions.appendChild(remBtn);
        card.appendChild(img); card.appendChild(meta); card.appendChild(actions);
        card.addEventListener('click', ()=> openPodcastDetail(p));
        libraryList.appendChild(card);
      });
    }

    function showPlayer(showTitle, episodeTitle, img, url, episodeMeta){
      audio.src = url || '';
      audio.play().catch(()=>{});
      playerBar.style.display='flex'; playerTitle.textContent = showTitle || ''; playerEpisode.textContent = episodeTitle||''; playerImg.src = img||''; playPauseBtn.textContent='⏸️';
      // show episode metadata tooltip or small info
      if(episodeMeta && episodeMeta.pubDate){ /* could show more */ }
    }

    playPauseBtn.addEventListener('click', ()=>{ if(!audio.src) return; if(audio.paused){ audio.play(); playPauseBtn.textContent='⏸️'; } else { audio.pause(); playPauseBtn.textContent='▶️'; } });

    // progress handling
    audio.addEventListener('timeupdate', ()=>{
      const pct = (audio.currentTime && audio.duration) ? (audio.currentTime/audio.duration*100) : 0;
      progressFill.style.width = pct + '%';
      const format = t => { if(!t || isNaN(t)) return '00:00'; const m = Math.floor(t/60); const s = Math.floor(t%60); return `${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`; };
      timeLabel.textContent = `${format(audio.currentTime)} / ${format(audio.duration)}`;
    });

    progressBar.addEventListener('click', (e)=>{
      const rect = progressBar.getBoundingClientRect(); const x = e.clientX - rect.left; const pct = x / rect.width; if(audio.duration) audio.currentTime = pct * audio.duration;
    });

    // Detail view: pagination and metadata
    async function openPodcastDetail(podcast){
      detailView.style.display='block'; exploreSection.style.display='none'; librarySection.style.display='none';
      detailView.innerHTML = '';

      const container = document.createElement('div'); container.className='detail';
      const head = document.createElement('div'); head.style.display='flex'; head.style.gap='12px'; head.style.alignItems='center';
      const img = document.createElement('img'); img.src = podcast.image || podcast.imgUrl || podcast.img || '';
      img.style.width='96px'; img.style.height='96px'; img.style.borderRadius='8px'; img.style.objectFit='cover';
      const info = document.createElement('div');
      const title = document.createElement('div'); title.style.fontSize='1.1rem'; title.style.fontWeight='700'; title.textContent = podcast.title || podcast.title_original || podcast.name || 'Bez názvu';
      const sub = document.createElement('div'); sub.style.color='var(--text-secondary)'; sub.textContent = podcast.publisher || podcast.publisher_original || podcast.description || '';
      info.appendChild(title); info.appendChild(sub);
      head.appendChild(img); head.appendChild(info);

      const backBtn = document.createElement('button'); backBtn.className='small-btn'; backBtn.textContent='⬅ Späť'; backBtn.addEventListener('click', ()=>{ detailView.style.display='none'; if(libraryTab.classList.contains('active')){ librarySection.style.display=''; } else { exploreSection.style.display=''; } });
      head.appendChild(backBtn);

      container.appendChild(head);

      // episodes area
      const episodesList = document.createElement('div'); episodesList.style.marginTop='12px';
      container.appendChild(episodesList);

      // pager controls
      const pager = document.createElement('div'); pager.style.display='flex'; pager.style.justifyContent='space-between'; pager.style.alignItems='center'; pager.style.marginTop='10px';
      const prevBtn = document.createElement('button'); prevBtn.className='small-btn'; prevBtn.textContent='Predošlé';
      const nextBtn = document.createElement('button'); nextBtn.className='small-btn'; nextBtn.textContent='Ďalšie';
      const pageInfo = document.createElement('div'); pageInfo.style.color='var(--text-secondary)';
      pager.appendChild(prevBtn); pager.appendChild(pageInfo); pager.appendChild(nextBtn);
      container.appendChild(pager);

      detailView.appendChild(container);

      let episodes = [];
      let perPage = 10; let page = 1;

      async function loadEpisodes(){
        episodesList.innerHTML = '<div style="color:var(--text-secondary)">Načítavam epizódy…</div>';
        try{
          // try ListenNotes first
          if(podcast.id){
            const url = `https://listen-api.listennotes.com/api/v2/podcasts/${podcast.id}?sort=recent_first`;
            const res = await fetch(url, { headers: { 'X-ListenAPI-Key': API_KEY } });
            if(res.ok){ const data = await res.json(); episodes = data.episodes || []; // data may include description, total_episodes
            // show metadata
            if(data.description) {
              const md = document.createElement('div'); md.style.marginTop='10px'; md.innerHTML = data.description; container.insertBefore(md, episodesList);
            }
            }
          }

          if(episodes.length===0 && (podcast.rss || podcast.feedUrl || podcast.feedUrl===null)){ 
            // try RSS
            const feed = podcast.rss || podcast.feedUrl || podcast.feedUrl || null;
            if(feed){
              const r = await fetch(feed);
              const text = await r.text();
              const parser = new DOMParser(); const xml = parser.parseFromString(text,'text/xml');
              const items = Array.from(xml.querySelectorAll('item'));
              episodes = items.map(item=>{
                const title = item.querySelector('title')?.textContent || 'Bez názvu';
                const audioUrl = item.querySelector('enclosure')?.getAttribute('url') || '';
                const pubDate = item.querySelector('pubDate')?.textContent || '';
                const duration = item.querySelector('itunes\:duration')?.textContent || item.querySelector('duration')?.textContent || '';
                const desc = item.querySelector('description')?.textContent || '';
                return { title, audio: audioUrl, pubDate, duration, description: desc };
              });
            }
          }

          if(episodes.length===0){ episodesList.innerHTML = '<div class="error-card">Nepodarilo sa načítať epizódy alebo nie sú verejne dostupné (CORS / feed).</div>'; return; }

          renderPage();
        }catch(err){ episodesList.innerHTML = `<div class="error-card">Chyba pri načítaní epizód: ${err.message}</div>`; }
      }

      function renderPage(){
        const start = (page-1)*perPage; const pageItems = episodes.slice(start, start+perPage);
        episodesList.innerHTML = '';
        pageInfo.textContent = `Strana ${page} • ${episodes.length} dielov`;
        pageItems.forEach(ep=>{
          const row = document.createElement('div'); row.className='episode-row';
          const left = document.createElement('div');
          const t = document.createElement('div'); t.className='episode-title'; t.textContent = ep.title || 'Bez názvu';
          const m = document.createElement('div'); m.className='episode-meta'; m.textContent = `${ep.pubDate ? new Date(ep.pubDate).toLocaleString() : ''}${ep.duration? ' • ' + ep.duration : ''}`;
          left.appendChild(t); left.appendChild(m);
          const btns = document.createElement('div'); btns.style.display='flex'; btns.style.gap='8px';
          const play = document.createElement('button'); play.className='small-btn'; play.textContent='▶ Prehrať';
          play.addEventListener('click', ()=> showPlayer(title.textContent, t.textContent, img.src, ep.audio, {pubDate:ep.pubDate, duration: ep.duration, description: ep.description}));
          btns.appendChild(play);
          row.appendChild(left); row.appendChild(btns);
          episodesList.appendChild(row);
        });

        prevBtn.disabled = page<=1; nextBtn.disabled = start+perPage>=episodes.length;
      }

      prevBtn.addEventListener('click', ()=>{ if(page>1){ page--; renderPage(); }});
      nextBtn.addEventListener('click', ()=>{ if((page*perPage) < episodes.length){ page++; renderPage(); }});

      await loadEpisodes();
    }

    // Initial render
    renderLibrary();
  </script>
</body>
</html>